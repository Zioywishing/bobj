
# Bobj - A modular JavaScript object serialization library

## Introduction  
Bobj is short for "Binary Object", and it is a lightweight, extensible JavaScript library designed to serialize JavaScript objects into a binary format (bobj) and deserialize bobj binary data back into JavaScript objects. It supports built-in data types (objects, arrays, `Uint8Array`, strings, numbers, booleans, `null`, and `undefined`) and provides a plugin system for custom data type handling.

### Key Features  
- **Multi-type Support**: Serializes/deserializes common JavaScript primitives and objects.  
- **Extensible Plugin System**: Add support for custom data types via plugins.  
- **Binary Format**: Efficient binary representation for compact storage/transmission.  


## Installation  
```bash
# Using pnpm
pnpm add bobj

# Using npm
npm install bobj
```


## Basic Usage  

### Serialization (Object → bobj Binary)  
```typescript
import { Serializer } from "bobj";

// Define an object to serialize
const exampleObj = {
  name: "Bobj",
  version: 1.0,
  tags: ["serialization", "binary"],
  active: true,
  metadata: new Uint8Array([0x01, 0x02, 0x03]),
  nesting:{
    name: "Bobj",
    version: 1.0,
    tags: ["serialization", "binary"],
    active: true,
    metadata: new Uint8Array([0x01, 0x02, 0x03]),
  }
};

// Create a serializer instance
const serializer = new Serializer();

// Serialize the object to a Uint8Array (bobj format)
const bobjBinary = await serializer.serialize(exampleObj);
// Output: Uint8Array([...binary data...])
```

### Deserialization (bobj Binary → Object)  
```typescript
import { Deserializer } from "bobj";

// Create a deserializer instance
const deserializer = new Deserializer();

// Deserialize the bobj binary back to an object
const restoredObj = await deserializer.deserialize(bobjBinary);
// Output: { name: "Bobj", version: 1.0, tags: ["serialization", "binary"], ... }
```


## Plugin Example: Custom Data Type Support  

Bobj’s plugin system allows you to extend serialization/deserialization for custom data types (e.g., `Date`, `Set`, or user-defined classes). Below is an example for handling `Date` objects.  

### Step 1: Create a Serialization Plugin  
Add a plugin to serialize `Date` objects into timestamps (stored as 8-byte floats).  

```typescript
// date-serializer-plugin.ts
import type { SerializerPluginType } from "../types/serializer";
import { numberToU8i } from "../utils/number_u8i_converter";

const DateSerializerPlugin: SerializerPluginType<Date> = {
  // Filter: Check if the target is a Date
  filter: (target) => target instanceof Date,
  // Unique type identifier
  targetType: new TextEncoder().encode("Date"),
  // Serialize Date to a timestamp (8-byte float)
  serialize: ({ target }) => {
    const timestamp = target.getTime();
    return numberToU8i(timestamp); // Convert number to Uint8Array
  },
};

export default DateSerializerPlugin;
```

### Step 2: Create a Deserialization Plugin  
Add a plugin to deserialize 8-byte floats back into `Date` objects.  

```typescript
// date-deserializer-plugin.ts
import type { DeserializerPluginType } from "../types/deserializer";
import { u8iToNumber } from "../utils/number_u8i_converter";

const DateDeserializerPlugin: DeserializerPluginType<Date> = {
  // Filter: Check if the value type is "Date"
  filter: new TextEncoder().encode("Date"),
  // Deserialize Uint8Array to Date
  deserialize: ({ targetArray }) => {
    const timestamp = u8iToNumber(targetArray); // Convert Uint8Array to number
    return new Date(timestamp);
  },
};

export default DateDeserializerPlugin;
```

### Step 3: Register Plugins  
Register the plugins with the `Serializer` and `Deserializer` to enable custom handling.  

```typescript
import { Serializer, Deserializer } from "bobj";
import DateSerializerPlugin from "./date-serializer-plugin";
import DateDeserializerPlugin from "./date-deserializer-plugin";

// Initialize serializer with the Date plugin
const serializer = new Serializer();
serializer.registerPlugin(DateSerializerPlugin);

// Initialize deserializer with the Date plugin
const deserializer = new Deserializer();
deserializer.registerPlugin(DateDeserializerPlugin);

// Test with a Date object
const testDate = {date: new Date("2024-01-01")};
const dateBinary = await serializer.serialize(testDate); // Uint8Array([...timestamp bytes...])
const restoredDate = await deserializer.deserialize(dateBinary); // { date: Date("2024-01-01") }
```


## Benchmark Comparison

### The benchmark code is generated by AI

All tests were run 100 times per case on Node.js, measuring average serialization/deserialization time (ms) and resulting data size (bytes).  
For large `Uint8Array` objects, JSON and BSON are skipped due to their limitations.

| Case                                             | Method   | Serialize (ms) | Deserialize (ms) | Data Size (bytes) |
|--------------------------------------------------|----------|----------------|------------------|-------------------|
| **Normal Object**                                | bobj     | 0.0806         | 0.0329           | 125               |
|                                                  | JSON     | 0.0013         | 0.0017           | 73                |
|                                                  | BSON     | 0.0515         | 0.0209           | 93                |
|                                                  | msgpack  | 0.0191         | 0.0159           | 46                |
| **Large Uint8Array (10MB)**                      | bobj     | 1.8537         | 1.6850           | 10,485,771        |
|                                                  | JSON     | N/A            | N/A              | N/A               |
|                                                  | BSON     | 3.4332         | 0.0058           | 10,485,776        |
|                                                  | msgpack  | 3.7397         | 1.7425           | 10,485,772        |
| **Large Uint8Array (100MB)**                     | bobj     | 20.8070        | 20.0427          | 104,857,612       |
|                                                  | JSON     | N/A            | N/A              | N/A               |
|                                                  | BSON     | N/A            | N/A              | N/A               |
|                                                  | msgpack  | 40.0457        | 20.1328          | 104,857,612       |
| **Large Uint8Array (500MB)**                     | bobj     | 98.2259        | 96.8874          | 524,288,012       |
|                                                  | JSON     | N/A            | N/A              | N/A               |
|                                                  | BSON     | N/A            | N/A              | N/A               |
|                                                  | msgpack  | 200.8493       | 96.9000          | 524,288,012       |
| **Deep Nested (depth=10, 100KB at last level)**  | bobj     | 0.0928         | 0.0675           | 102,491           |
|                                                  | JSON     | N/A            | N/A              | N/A               |
|                                                  | BSON     | 0.0687         | 0.0089           | 102,496           |
|                                                  | msgpack  | 0.1236         | 0.0583           | 102,442           |
| **Deep Nested (depth=1000, 100KB at last level)**| bobj     | 2.5542         | 1.2862           | 110,411           |
|                                                  | JSON     | N/A            | N/A              | N/A               |
|                                                  | BSON     | 0.5326         | 0.1837           | 110,416           |
|                                                  | msgpack  | 0.4572         | 0.3025           | 105,412           |
| **Deep Nested (depth=1000, 100MB at last level)**| bobj     | 23.2607        | 21.2426          | 104,866,612       |
|                                                  | JSON     | N/A            | N/A              | N/A               |
|                                                  | BSON     | N/A            | N/A              | N/A               |
|                                                  | msgpack  | 40.0522        | 20.7691          | 104,860,612       |

**Notes:**
- "N/A" means the method is not applicable due to format limitations (e.g., JSON cannot handle `Uint8Array`, BSON has a 16MB document size limit).
- All times are averages over 100 runs, measured in milliseconds.
- Data size is the serialized byte length.
- For deep nested cases, only the deepest level contains the actual data (`Uint8Array`), while all upper levels are just nested objects without additional payload.
- **Implementations used in the benchmark:**
  - **JSON:** Node.js built-in `JSON.stringify` and `JSON.parse`
  - **BSON:** [`bson`](https://www.npmjs.com/package/bson) (`BSON.serialize`, `BSON.deserialize`)
  - **msgpack:** [`msgpack-lite`](https://www.npmjs.com/package/msgpack-lite) (`msgpack.encode`, `msgpack.decode`)

## bobj Binary Format Specification  
Each element in the bobj binary follows this structure:  

| 8 bits       | 8 bits       | 8 bits       | Variable bits | Variable bits | Variable bits | Variable bits |
|--------------|--------------|--------------|---------------|---------------|---------------|---------------|
| Key length   | Value type length | Value length length | Key           | Value type    | Value length  | Value data    |  

- **Key length**: Length of the key (in bytes, 0-255).  
- **Value type length**: Length of the value type identifier (e.g., "Number", "Date", in bytes, 0-255).  
- **Value length length**: Length of the value length field (in bytes, 0-255).  
- **Key**: UTF-8 encoded key string.  
- **Value type**: UTF-8 encoded type identifier (e.g., "String", "Array").  
- **Value length**: Binary representation of the value data length (converted via `int2bytes`).  
- **Value data**: Binary data of the value (e.g., string bytes, number bytes).  


## License  
MIT © [MiaoSpring](https://github.com/Zioywishing)